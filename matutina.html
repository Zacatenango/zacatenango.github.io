<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morning Routine Tracker</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            padding-bottom: 40px;
        }
        .app-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        .task-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f8f9fa;
            transition: all 0.3s;
        }
        .task-item:hover {
            background-color: #e9ecef;
        }
        .task-done {
            background-color: #d4edda;
        }
        .task-done:hover {
            background-color: #c3e6cb;
        }
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
            height: 350px;
            max-height: 400px;
            overflow: hidden;
        }
        .timer-running {
            color: #dc3545;
            font-weight: bold;
        }
        .timer-paused {
            color: #ffc107;
            font-weight: bold;
        }
        #resumeRoutine {
            display: none;
        }
        .btn-group {
            display: flex;
            gap: 5px;
        }
        .summary-box {
            background-color: #f0f7ff;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .streak-count {
            font-size: 24px;
            font-weight: bold;
            color: #198754;
        }
        .interruption-form {
            display: none;
            margin: 15px 0;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeeba;
        }
        .interruption-form.visible {
            display: block;
        }
        .interruption-history {
            margin-top: 20px;
        }
        .interruption-history table {
            width: 100%;
            margin-top: 10px;
        }
        .interruption-history th {
            background-color: #f8f9fa;
            padding: 8px;
            border-bottom: 2px solid #dee2e6;
        }
        .interruption-history td {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        canvas {
            max-height: 300px !important;
        }
        .task-in-progress {
            border-left: 4px solid #0d6efd;
            background-color: #e7f1ff !important;
        }
        .interruption-section {
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        .interruption-btn {
            height: 100px;
            font-size: 1.2em;
            margin-bottom: 15px;
            white-space: normal;
        }
        .progress-steps {
            list-style: none;
            padding: 0;
        }
        .progress-steps li {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .progress-steps li.completed {
            background-color: #d4edda;
        }
        .chart-stack {
            margin-top: 20px;
        }
        .draggable-task {
            cursor: move;
        }
        .sortable-ghost {
            opacity: 0.5;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container app-container">
        <h1 class="text-center mb-4">Morning Routine Tracker</h1>
        
        <div class="summary-box">
            <div class="row">
                <div class="col-md-3">
                    <p>Current Streak: <span id="currentStreak" class="streak-count">0</span> days</p>
                </div>
                <div class="col-md-3">
                    <p>Completion Rate: <span id="completionRate">0%</span></p>
                </div>
                <div class="col-md-3">
                    <p>Average Duration: <span id="averageDuration">0</span> min</p>
                </div>
                <div class="col-md-3">
                    <p>Time to First Task: <span id="timeToFirstTask">--:--</span></p>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <h3>Today's Routine <small id="currentDate" class="text-muted"></small></h3>
                <div id="routineStatus" class="alert alert-info">
                    Ready to start your routine
                </div>
                <div id="interruption-form" class="interruption-form">
                    <h5>Log Interruption</h5>
                    <div class="form-group">
                        <label for="interruption-reason">What interrupted you?</label>
                        <textarea id="interruption-reason" class="form-control" rows="2"></textarea>
                    </div>
                    <button id="save-interruption" class="btn btn-warning mt-2">Save Interruption</button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <p>Current Timer: <span id="currentTimer">00:00</span></p>
                <div class="btn-group">
                    <button id="startRoutine" class="btn btn-primary">Start Routine</button>
                    <button id="completeRoutine" class="btn btn-success" disabled>Complete Routine</button>
                    <button id="pauseRoutine" class="btn btn-warning" disabled>Pause Routine</button>
                    <button id="resumeRoutine" class="btn btn-info" disabled>Resume Routine</button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <h4>Routine Tasks</h4>
                <div id="taskList">
                    <!-- Tasks will be loaded here -->
                </div>
                
                <div class="mt-3">
                    <div class="input-group">
                        <input type="text" id="newTaskInput" class="form-control" placeholder="Add new task">
                        <button id="addTask" class="btn btn-outline-primary">Add Task</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mb-4">
            <div class="col-12">
                <div class="interruption-section">
                    <h4>Interruption Recovery</h4>
                    <p class="text-muted">Select the appropriate reset based on interruption severity:</p>
                    <div class="row">
                        <div class="col-md-4">
                            <button class="btn btn-success interruption-btn w-100" data-reset-type="minor" data-duration="30" data-steps="Take a deep breath, Look at your tracker, State what comes next">
                                30 Second Reset
                                <br><small>Minor Interruption</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning interruption-btn w-100" data-reset-type="moderate" data-duration="120" data-steps="Splash cold water on face, Quick body shake, Return to routine">
                                2 Minute Reset
                                <br><small>Moderate Interruption</small>
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-danger interruption-btn w-100" data-reset-type="major" data-duration="300" data-steps="Brief meditation, Review entire remaining routine, Begin where I left off">
                                5 Minute Reset
                                <br><small>Major Interruption</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reset Confirmation Modal -->
        <div class="modal fade" id="resetConfirmModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Confirm Reset</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="resetDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="startRecoveryBtn">Start Recovery</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recovery Progress Modal -->
        <div class="modal fade" id="recoveryProgressModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Recovery in Progress</h5>
                    </div>
                    <div class="modal-body">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="recoverySteps" class="mb-3"></div>
                        <div id="currentRecoveryStep" class="alert alert-info"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="completeRecoveryBtn" disabled>
                            Complete and Return to Routine
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add the new chart containers -->
        <div class="chart-container">
            <h4>Compliance History</h4>
            <canvas id="complianceChart"></canvas>
        </div>

        <div class="chart-container">
            <h4>Daily Interruptions</h4>
            <canvas id="interruptionsChart"></canvas>
        </div>

        <div class="chart-container">
            <h4>Steps Interruption Frequency</h4>
            <canvas id="stepsInterruptionChart"></canvas>
        </div>

        <div class="chart-container">
            <h4>Interruption Duration Distribution</h4>
            <canvas id="durationHistogramChart"></canvas>
        </div>
        
        <div class="interruption-history">
            <h4>Interruption History</h4>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="interruption-log">
                    <tr>
                        <td colspan="4">No interruptions logged yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // Initialize Firebase
        // Replace this with your own Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyArRfYoAEW946F9aIsnzht3PNoqSIc9k3Q",
            authDomain: "misaplicaciones-a39bb.firebaseapp.com",
            databaseURL: "https://misaplicaciones-a39bb-default-rtdb.firebaseio.com",
            projectId: "misaplicaciones-a39bb",
            storageBucket: "misaplicaciones-a39bb.firebasestorage.app",
            messagingSenderId: "375780546756",
            appId: "1:375780546756:web:c87ad2c8f5c7e71869d191",
            measurementId: "G-NSZ17K1N89"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Initialize date
        const today = new Date();
        const dateString = today.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        $('#currentDate').text(dateString);

        // Global Firebase database references
        const historialRutinaRef = database.ref('historial_rutina');
        const matutinaRef = database.ref('matutina');
        const timerStateRef = database.ref('timer_state');
        const interruptionsRef = database.ref('interruptions');

        // App state variables
        let tasks = [];
        let routineStartTime = null;
        let timeToFirstTask = null;  // Track time until first task completion
        let firstTaskCompleted = false;
        let timerInterval = null;
        let complianceData = [];
        let complianceChart = null;
        let isPaused = false;
        let totalPausedTime = 0;
        let lastPauseTime = null;
        let currentInterruptionId = null;

        // Load interruptions from Firebase
        function loadInterruptions() {
            interruptionsRef.orderByChild('timestamp').limitToLast(50).once('value')
                .then((snapshot) => {
                    const interruptions = [];
                    snapshot.forEach((childSnapshot) => {
                        interruptions.unshift({...childSnapshot.val()});
                    });
                    
                    const tbody = $('#interruption-log');
                    tbody.empty();
                    
                    if (interruptions.length === 0) {
                        tbody.append('<tr><td colspan="4">No interruptions logged yet</td></tr>');
                    } else {
                        interruptions.forEach(interruption => {
                            const date = new Date(interruption.timestamp);
                            const formattedDate = date.toLocaleDateString();
                            const formattedTime = date.toLocaleTimeString();
                            const duration = Math.round(interruption.duration / 60000); // Convert ms to minutes
                            
                            tbody.append(`
                                <tr>
                                    <td>${formattedDate}</td>
                                    <td>${formattedTime}</td>
                                    <td>${duration} min</td>
                                    <td>${interruption.reason}</td>
                                </tr>
                            `);
                        });
                    }
                });
        }

        function showInterruptionForm() {
            $('#interruption-form').addClass('visible');
            $('#interruption-reason').val('').focus();
        }

        function hideInterruptionForm() {
            $('#interruption-form').removeClass('visible');
            $('#interruption-reason').val('');
        }

        function saveInterruption() {
            const reason = $('#interruption-reason').val().trim();
            if (!reason) {
                alert('Please provide a reason for the interruption');
                return;
            }
            
            const now = new Date();
            const duration = now - lastPauseTime;
            
            const interruption = {
                timestamp: now.getTime(),
                reason: reason,
                duration: duration,
                routineId: routineStartTime.getTime()
            };
            
            currentInterruptionId = interruptionsRef.push().key;
            interruptionsRef.child(currentInterruptionId).set(interruption)
                .then(() => {
                    hideInterruptionForm();
                    loadInterruptions();
                })
                .catch(error => {
                    console.error("Error saving interruption:", error);
                    alert('Error saving interruption. Please try again.');
                });
        }

        // Start routine timer
        function startRoutine() {
            routineStartTime = new Date();
            isPaused = false;
            totalPausedTime = 0;
            lastPauseTime = null;
            
            // Save timer state to Firebase first
            timerStateRef.set({
                running: true,
                startTime: routineStartTime.toISOString(),
                paused: false,
                totalPausedTime: 0
            }).then(() => {
                updateButtonStates();
                $('#routineStatus').removeClass('alert-info').addClass('alert-warning')
                    .html('Routine in progress... <span class="timer-running">Timer running</span>');

                // Reset all task checkboxes
                tasks.forEach(task => {
                    updateTaskStatus(task.id, false);
                });

                startTimerIntervals();
            });
        }

        function startTimerIntervals() {
            // Clear any existing intervals
            if (timerInterval) {
                clearInterval(timerInterval.display);
                clearInterval(timerInterval.sync);
            }
            
            // Start display timer (updates every second)
            updateTimer();
            const displayInterval = setInterval(updateTimer, 1000);

            // Start Firebase sync timer (syncs every 15 seconds)
            // (less than that could consume our free usage quota)
            const syncInterval = setInterval(syncTimerState, 15000);
            
            // Store both intervals
            timerInterval = { display: displayInterval, sync: syncInterval };
        }

        function updateButtonStates() {
            $('#startRoutine').prop('disabled', routineStartTime !== null);
            $('#completeRoutine').prop('disabled', !routineStartTime || isPaused);
            $('#pauseRoutine').prop('disabled', !routineStartTime || isPaused);
            $('#resumeRoutine').prop('disabled', !routineStartTime || !isPaused);
            
            // Show/hide buttons based on state
            if (routineStartTime) {
                if (isPaused) {
                    $('#pauseRoutine').hide();
                    $('#resumeRoutine').show();
                } else {
                    $('#pauseRoutine').show();
                    $('#resumeRoutine').hide();
                }
            }
        }

        function pauseTimer() {
            if (!routineStartTime || isPaused) return;
            
            isPaused = true;
            lastPauseTime = new Date();
            
            // Store which task was in progress when paused
            const currentTask = tasks.find(t => t.inProgress);
            if (currentTask) {
                currentInProgressTaskId = currentTask.id;
            }
            
            // Clear intervals
            if (timerInterval) {
                clearInterval(timerInterval.display);
                clearInterval(timerInterval.sync);
            }
            
            updateButtonStates();
            $('#routineStatus').html('Routine paused... <span class="timer-paused">Timer paused</span>');
            
            // Show interruption form
            showInterruptionForm();
            
            // Update Firebase state
            timerStateRef.update({
                paused: true,
                lastPauseTime: lastPauseTime.toISOString(),
                currentInProgressTaskId: currentInProgressTaskId
            });
        }

        function resumeTimer() {
            if (!routineStartTime || !isPaused) return;
            
            // Hide interruption form if visible
            hideInterruptionForm();
            
            // Calculate paused duration and log the interruption
            const now = new Date();
            const pauseDuration = now - lastPauseTime;
            totalPausedTime += pauseDuration;
            
            // Log the interruption with the current task
            const interruption = {
                timestamp: now.getTime(),
                duration: pauseDuration,
                routineId: routineStartTime.getTime(),
                currentStep: tasks.find(t => t.id === currentInProgressTaskId)?.name
            };
            
            interruptionsRef.push(interruption).then(() => {
                // Refresh charts
                renderInterruptionsChart();
                renderStepsInterruptionChart();
                renderDurationHistogramChart();
            });
            
            isPaused = false;
            lastPauseTime = null;
            currentInProgressTaskId = null;
            
            updateButtonStates();
            $('#routineStatus').html('Routine in progress... <span class="timer-running">Timer running</span>');
            
            // Update Firebase state
            timerStateRef.update({
                paused: false,
                totalPausedTime: totalPausedTime,
                currentInProgressTaskId: null
            });
            
            startTimerIntervals();
        }

        // Update timer display
        function updateTimer() {
            if (!routineStartTime || isPaused) return;

            const now = new Date();
            const elapsedMs = (now - routineStartTime) - totalPausedTime;
            const minutes = Math.floor(elapsedMs / 60000);
            const seconds = Math.floor((elapsedMs % 60000) / 1000);

            $('#currentTimer').text(`${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);

            // Update time to first task if not yet completed
            if (!firstTaskCompleted) {
                const firstTaskMinutes = Math.floor(elapsedMs / 60000);
                const firstTaskSeconds = Math.floor((elapsedMs % 60000) / 1000);
                $('#timeToFirstTask').text(`${firstTaskMinutes.toString().padStart(2, '0')}:${firstTaskSeconds.toString().padStart(2, '0')}`);
            }
        }

        // Sync timer state to Firebase
        function syncTimerState() {
            if (!routineStartTime) return;

            const now = new Date();
            const elapsedMs = (now - routineStartTime) - totalPausedTime;
            const minutes = Math.floor(elapsedMs / 60000);
            const seconds = Math.floor((elapsedMs % 60000) / 1000);

            timerStateRef.update({
                running: true,
                elapsedMinutes: minutes,
                elapsedSeconds: seconds,
                totalPausedTime: totalPausedTime,
                paused: isPaused,
                startTime: routineStartTime.toISOString(),
                lastPauseTime: lastPauseTime ? lastPauseTime.toISOString() : null,
                currentInProgressTaskId: currentInProgressTaskId,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Load timer state from Firebase
        function loadTimerState() {
            timerStateRef.on('value', (snapshot) => {
                const state = snapshot.val();
                if (state && state.running) {
                    routineStartTime = new Date(state.startTime);
                    isPaused = state.paused || false;
                    totalPausedTime = state.totalPausedTime || 0;
                    currentInProgressTaskId = state.currentInProgressTaskId || null;
                    
                    if (isPaused && state.lastPauseTime) {
                        lastPauseTime = new Date(state.lastPauseTime);
                    }
                    
                    // Clear existing intervals if any
                    if (timerInterval) {
                        clearInterval(timerInterval.display);
                        clearInterval(timerInterval.sync);
                    }

                    // Update UI immediately
                    updateTimer();
                    updateButtonStates();
                    updateUIState();
                    
                    // Start new intervals if not paused
                    if (!isPaused) {
                        startTimerIntervals();
                    }
                } else {
                    // Reset state if routine is not running
                    routineStartTime = null;
                    isPaused = false;
                    totalPausedTime = 0;
                    lastPauseTime = null;
                    currentInProgressTaskId = null;
                    
                    // Clear intervals
                    if (timerInterval) {
                        clearInterval(timerInterval.display);
                        clearInterval(timerInterval.sync);
                    }
                    
                    updateButtonStates();
                    updateUIState();
                }
            });
        }

        function updateUIState() {
            if (!routineStartTime) {
                $('#routineStatus').removeClass('alert-warning alert-success').addClass('alert-info')
                    .html('Ready to start your routine');
                return;
            }

            if (isPaused) {
                $('#routineStatus').removeClass('alert-info alert-success').addClass('alert-warning')
                    .html('Routine paused... <span class="timer-paused">Timer paused</span>');
                showInterruptionForm();
                updateTimer(); // Update timer display immediately
            } else {
                $('#routineStatus').removeClass('alert-info alert-success').addClass('alert-warning')
                    .html('Routine in progress... <span class="timer-running">Timer running</span>');
                hideInterruptionForm();
                startTimerIntervals();
            }
        }

        // Complete routine
        function completeRoutine() {
            if (!routineStartTime || isPaused) return;

            // Clear intervals
            if (timerInterval) {
                clearInterval(timerInterval.display);
                clearInterval(timerInterval.sync);
            }

            const endTime = new Date();
            const durationMinutes = Math.round(((endTime - routineStartTime) - totalPausedTime) / 60000);

            // Count completed tasks
            const completedCount = tasks.filter(task => task.completed).length;
            const completionPercent = tasks.length > 0 ? Math.round((completedCount / tasks.length) * 100) : 0;

            // Save routine record to Firebase
            const routineRecord = {
                date: dateString,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                durationMinutes: durationMinutes,
                tasksCompleted: completedCount,
                totalTasks: tasks.length,
                completionRate: completionPercent,
                totalPausedTimeMinutes: Math.round(totalPausedTime / 60000),
                timeToFirstTaskMs: timeToFirstTask || null  // Save time to first task
            };

            historialRutinaRef.push(routineRecord);

            // Reset timer state in Firebase
            timerStateRef.set({
                running: false,
                paused: false
            });

            // Reset UI and variables
            routineStartTime = null;
            isPaused = false;
            totalPausedTime = 0;
            lastPauseTime = null;
            
            updateButtonStates();
            $('#routineStatus').removeClass('alert-warning').addClass('alert-success')
                .html(`Routine completed! <strong>${durationMinutes} minutes</strong> with ${completionPercent}% tasks completed`);

            loadComplianceData();
        }

        // Load compliance data for the chart
        function loadComplianceData() {
            historialRutinaRef.orderByChild('timestamp').limitToLast(30)
                .once('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    complianceData = Object.values(data);

                    // Calculate streaks and averages
                    calculateStats(complianceData);

                    // Render chart
                    renderComplianceChart(complianceData);
                });
        }

        // Calculate stats from compliance data
        function calculateStats(data) {
            // Sort by timestamp
            data.sort((a, b) => a.timestamp - b.timestamp);
            
            // Calculate current streak
            let currentStreak = 0;
            const msPerDay = 24 * 60 * 60 * 1000;
            
            for (let i = data.length - 1; i >= 0; i--) {
                if (i === data.length - 1) {
                    // Check if latest record is from today
                    const recordDate = new Date(data[i].timestamp);
                    const today = new Date();
                    if (today.toDateString() === recordDate.toDateString()) {
                        currentStreak = 1;
                    } else {
                        const dayDiff = Math.floor((today - recordDate) / msPerDay);
                        if (dayDiff > 1) break; // Streak broken
                        currentStreak = 1;
                    }
                } else {
                    const currentDate = new Date(data[i].timestamp);
                    const prevDate = new Date(data[i+1].timestamp);
                    const dayDiff = Math.floor((prevDate - currentDate) / msPerDay);
                    
                    if (dayDiff <= 1) {
                        currentStreak++;
                    } else {
                        break; // Streak broken
                    }
                }
            }
            
            $('#currentStreak').text(currentStreak);
            
            // Calculate completion rate
            if (data.length > 0) {
                const totalCompletionRate = data.reduce((sum, record) => sum + record.completionRate, 0);
                const avgCompletionRate = Math.round(totalCompletionRate / data.length);
                $('#completionRate').text(`${avgCompletionRate}%`);
                
                // Calculate average duration
                const totalDuration = data.reduce((sum, record) => sum + record.durationMinutes, 0);
                const avgDuration = Math.round(totalDuration / data.length);
                $('#averageDuration').text(avgDuration);
            }
        }

        // Render compliance chart
        function renderComplianceChart(data) {
            // Prepare data for chart
            const labels = data.map(record => record.date);
            const durations = data.map(record => record.durationMinutes);
            const completionRates = data.map(record => record.completionRate);
            const firstTaskTimes = data.map(record => record.timeToFirstTaskMs ? Math.round(record.timeToFirstTaskMs / 60000) : null);
            
            const ctx = document.getElementById('complianceChart').getContext('2d');
            
            if (complianceChart) {
                complianceChart.destroy();
            }
            
            complianceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Duration (minutes)',
                            data: durations,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Completion Rate (%)',
                            data: completionRates,
                            type: 'line',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Time to First Task (minutes)',
                            data: firstTaskTimes,
                            type: 'line',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Minutes'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            max: 100,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Completion Rate (%)'
                            }
                        }
                    }
                }
            });
        }

        // Event listeners and initialization
        $(document).ready(function() {
            // Load initial data
            matutinaRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                tasks = Object.keys(data).map(key => ({
                    id: key,
                    name: data[key].name,
                    completed: data[key].completed || false,
                    inProgress: data[key].inProgress || false,
                    order: data[key].order || 0
                }));
                
                // Sort tasks by order
                tasks.sort((a, b) => (a.order || 0) - (b.order || 0));
                renderTasks();
            });

            loadComplianceData();
            loadTimerState();
            loadInterruptions();
            initializeCharts();
            
            // Initialize Sortable
            new Sortable(taskList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    const taskIds = Array.from(taskList.children).map(item => item.dataset.id);
                    updateTaskOrder(taskIds);
                }
            });

            // Add other event listeners
            // Add task button
            $('#addTask').on('click', function() {
                const taskName = $('#newTaskInput').val().trim();
                if (taskName) {
                    addTask(taskName);
                    $('#newTaskInput').val('');
                }
            });

            // Enter key on input
            $('#newTaskInput').on('keypress', function(e) {
                if (e.which === 13) {
                    const taskName = $(this).val().trim();
                    if (taskName) {
                        addTask(taskName);
                        $(this).val('');
                    }
                }
            });

            // Start routine button
            $('#startRoutine').on('click', startRoutine);

            // Pause routine button
            $('#pauseRoutine').on('click', pauseTimer);

            // Resume routine button
            $('#resumeRoutine').on('click', resumeTimer);

            // Complete routine button
            $('#completeRoutine').on('click', completeRoutine);

            // Save interruption button
            $('#save-interruption').on('click', saveInterruption);

            // Handle Enter key in interruption reason textarea
            $('#interruption-reason').on('keypress', function(e) {
                if (e.which === 13 && !e.shiftKey) {
                    e.preventDefault();
                    saveInterruption();
                }
            });
        });

        // Add a new task
        function addTask(taskName) {
            // Get the highest current order
            const maxOrder = tasks.reduce((max, task) => Math.max(max, task.order || 0), -1);
            
            const newTaskRef = matutinaRef.push();
            newTaskRef.set({
                name: taskName,
                completed: false,
                inProgress: false,
                order: maxOrder + 1,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // Render tasks in the UI
        function renderTasks() {
            const taskListElement = $('#taskList');
            taskListElement.empty();
            
            if (tasks.length === 0) {
                taskListElement.append('<p class="text-muted">No tasks added yet. Add your first task below.</p>');
                return;
            }
            
            tasks.forEach(task => {
                const taskElement = $(`
                    <div class="task-item draggable-task ${task.completed ? 'task-done' : ''} ${task.inProgress ? 'task-in-progress' : ''}" data-id="${task.id}">
                        <div class="form-check d-flex justify-content-between align-items-center">
                            <div>
                                <input class="form-check-input task-checkbox" type="checkbox" 
                                       id="task-${task.id}" ${task.completed ? 'checked' : ''}>
                                <label class="form-check-label" for="task-${task.id}">
                                    ${task.name}
                                </label>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary set-in-progress" ${task.completed ? 'disabled' : ''}>
                                    <i class="bi bi-play-fill"></i> Set In Progress
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-task">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                taskListElement.append(taskElement);
            });

            // Add event listeners for checkboxes, in-progress buttons, and delete buttons
            $('.task-checkbox').on('change', function() {
                const taskId = $(this).closest('.task-item').data('id');
                const isCompleted = $(this).is(':checked');
                updateTaskStatus(taskId, isCompleted);
            });
            
            $('.set-in-progress').on('click', function() {
                const taskId = $(this).closest('.task-item').data('id');
                toggleInProgress(taskId);
            });
            
            $('.delete-task').on('click', function() {
                const taskId = $(this).closest('.task-item').data('id');
                deleteTask(taskId);
            });
        }

        function toggleInProgress(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // If this task is being set to in-progress, clear other in-progress tasks
            if (!task.inProgress) {
                tasks.forEach(t => {
                    if (t.id !== taskId && t.inProgress) {
                        matutinaRef.child(t.id).update({ inProgress: false });
                        t.inProgress = false;
                    }
                });
            }

            task.inProgress = !task.inProgress;
            matutinaRef.child(taskId).update({ inProgress: task.inProgress });
            renderTasks();
        }

        function updateTaskStatus(taskId, isCompleted) {
            matutinaRef.child(taskId).update({
                completed: isCompleted,
                inProgress: isCompleted ? false : tasks.find(t => t.id === taskId)?.inProgress || false
            });
            
            // Update local tasks array
            const taskIndex = tasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                tasks[taskIndex].completed = isCompleted;
                if (isCompleted) {
                    tasks[taskIndex].inProgress = false;
                }

                // Track time to first task completion
                if (isCompleted && !firstTaskCompleted && routineStartTime) {
                    firstTaskCompleted = true;
                    const now = new Date();
                    timeToFirstTask = (now - routineStartTime) - totalPausedTime;
                }
            }
            
            // Update UI
            renderTasks();
        }

        // Delete a task
        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                matutinaRef.child(taskId).remove();
                tasks = tasks.filter(t => t.id !== taskId);
                renderTasks();
            }
        }

        // Interruption Management
        let currentResetType = null;
        let currentResetDuration = null;
        let resetInterval = null;

        // Initialize Sortable for task list
        const taskList = document.getElementById('taskList');
        new Sortable(taskList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const taskIds = Array.from(taskList.children).map(item => item.dataset.id);
                updateTaskOrder(taskIds);
            }
        });

        function updateTaskOrder(taskIds) {
            const updates = {};
            taskIds.forEach((id, index) => {
                updates[`${id}/order`] = index;
            });
            matutinaRef.update(updates);
        }

        // Initialize new charts
        let interruptionsChart = null;
        let stepsInterruptionChart = null;
        let durationHistogramChart = null;

        function initializeCharts() {
            renderInterruptionsChart();
            renderStepsInterruptionChart();
            renderDurationHistogramChart();
        }

        function renderInterruptionsChart() {
            const ctx = document.getElementById('interruptionsChart').getContext('2d');
            interruptionsRef.orderByChild('timestamp').limitToLast(30).once('value', snapshot => {
                const data = {};
                snapshot.forEach(child => {
                    const interruption = child.val();
                    const date = new Date(interruption.timestamp).toLocaleDateString();
                    if (!data[date]) {
                        data[date] = { minor: 0, moderate: 0, major: 0, totalTime: 0 };
                    }
                    
                    if (interruption.duration <= 30000) data[date].minor++;
                    else if (interruption.duration <= 120000) data[date].moderate++;
                    else data[date].major++;
                    
                    data[date].totalTime += interruption.duration / 60000; // Convert to minutes
                });

                const labels = Object.keys(data);
                const minorData = labels.map(date => data[date].minor);
                const moderateData = labels.map(date => data[date].moderate);
                const majorData = labels.map(date => data[date].major);
                const timeData = labels.map(date => Math.round(data[date].totalTime));

                if (interruptionsChart) interruptionsChart.destroy();
                interruptionsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Minor',
                                data: minorData,
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                stack: 'Stack 0'
                            },
                            {
                                label: 'Moderate',
                                data: moderateData,
                                backgroundColor: 'rgba(255, 206, 86, 0.5)',
                                stack: 'Stack 0'
                            },
                            {
                                label: 'Major',
                                data: majorData,
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                stack: 'Stack 0'
                            },
                            {
                                label: 'Total Time (minutes)',
                                data: timeData,
                                type: 'line',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            },
                            y1: {
                                beginAtZero: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Minutes'
                                }
                            }
                        }
                    }
                });
            });
        }

        function renderStepsInterruptionChart() {
            const ctx = document.getElementById('stepsInterruptionChart').getContext('2d');
            interruptionsRef.once('value', snapshot => {
                const stepCounts = {};
                tasks.forEach(task => {
                    stepCounts[task.name] = 0;
                });

                snapshot.forEach(child => {
                    const interruption = child.val();
                    if (interruption.currentStep) {
                        stepCounts[interruption.currentStep] = (stepCounts[interruption.currentStep] || 0) + 1;
                    }
                });

                if (stepsInterruptionChart) stepsInterruptionChart.destroy();
                stepsInterruptionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(stepCounts),
                        datasets: [{
                            label: 'Interruptions',
                            data: Object.values(stepCounts),
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Interruptions'
                                }
                            }
                        }
                    }
                });
            });
        }

        function renderDurationHistogramChart() {
            const ctx = document.getElementById('durationHistogramChart').getContext('2d');
            interruptionsRef.once('value', snapshot => {
                const buckets = Array(12).fill(0); // 12 buckets of 5 minutes each (0-60 minutes)
                
                snapshot.forEach(child => {
                    const interruption = child.val();
                    const durationMinutes = interruption.duration / 60000;
                    const bucketIndex = Math.min(Math.floor(durationMinutes / 5), 11);
                    buckets[bucketIndex]++;
                });

                const labels = buckets.map((_, i) => `${i*5}-${(i+1)*5} min`);

                if (durationHistogramChart) durationHistogramChart.destroy();
                durationHistogramChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: buckets,
                            backgroundColor: 'rgba(255, 159, 64, 0.5)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Number of Interruptions'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Duration'
                                }
                            }
                        }
                    }
                });
            });
        }

        // Interruption reset handling
        $('.interruption-btn').on('click', function() {
            currentResetType = $(this).data('reset-type');
            currentResetDuration = parseInt($(this).data('duration'));
            const steps = $(this).data('steps').split(', ');
            
            const resetDetails = `
                <h4>${currentResetDuration} Second ${currentResetType.charAt(0).toUpperCase() + currentResetType.slice(1)} Reset</h4>
                <p>Steps to follow:</p>
                <ol>
                    ${steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
            
            $('#resetDetails').html(resetDetails);
            $('#resetConfirmModal').modal('show');
        });

        $('#startRecoveryBtn').on('click', function() {
            $('#resetConfirmModal').modal('hide');
            startRecoveryTimer();
        });

        function startRecoveryTimer() {
            const steps = $('.interruption-btn[data-reset-type="' + currentResetType + '"]').data('steps').split(', ');
            const stepDuration = Math.floor(currentResetDuration / steps.length);
            let currentStep = 0;
            let timeElapsed = 0;

            // Setup recovery modal
            $('#recoverySteps').html(`
                <ol class="progress-steps">
                    ${steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `);
            $('#currentRecoveryStep').text(steps[0]);
            $('.progress-bar').css('width', '0%');
            $('#recoveryProgressModal').modal('show');

            resetInterval = setInterval(() => {
                timeElapsed++;
                const progress = (timeElapsed / currentResetDuration) * 100;
                $('.progress-bar').css('width', progress + '%');

                const currentStepIndex = Math.min(Math.floor(timeElapsed / stepDuration), steps.length - 1);
                if (currentStepIndex !== currentStep) {
                    currentStep = currentStepIndex;
                    $('#currentRecoveryStep').text(steps[currentStep]);
                    $('.progress-steps li').removeClass('completed');
                    for (let i = 0; i <= currentStep; i++) {
                        $('.progress-steps li').eq(i).addClass('completed');
                    }
                }

                if (timeElapsed >= currentResetDuration) {
                    clearInterval(resetInterval);
                    $('#completeRecoveryBtn').prop('disabled', false);
                }
            }, 1000);
        }

        $('#completeRecoveryBtn').on('click', function() {
            clearInterval(resetInterval);
            $('#recoveryProgressModal').modal('hide');
            
            // Log the interruption recovery
            const recovery = {
                timestamp: Date.now(),
                type: currentResetType,
                duration: currentResetDuration * 1000,
                routineId: routineStartTime ? routineStartTime.getTime() : null
            };
            
            interruptionsRef.push(recovery).then(() => {
                // Refresh charts
                renderInterruptionsChart();
                renderStepsInterruptionChart();
                renderDurationHistogramChart();
            });
        });

        // Initialize charts on page load
        $(document).ready(function() {
            // ...existing document.ready code...
            initializeCharts();
        });
    </script>
</body>
</html>
